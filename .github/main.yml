# .github/workflows/main.yml
name: CI Build et Push Images Docker

on:
  push:
    branches:
      - main  # DÃ©clenche sur chaque push vers la branche 'main'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: âš™ï¸ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Docker Buildx (NÃ©cessaire pour les builds multi-plateformes)
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ”‘ Login au Docker Hub
        uses: docker/login-action@v3
        with:
          # Les secrets doivent Ãªtre configurÃ©s dans les rÃ©glages de votre dÃ©pÃ´t GitHub
          username: ${{ secrets.DOCKER_USERNAME }} 
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: ğŸ·ï¸ DÃ©finir les Tags pour les Images
        id: meta
        uses: docker/metadata-action@v5
        with:
          # Utilise le hash du commit de 8 caractÃ¨res comme tag de version (ex: 1a2b3c4d)
          images: votre_nom_utilisateur/aspporcelette
          tags: |
            type=sha,format=short
            
      # --- JOB 1 : Construction et Push du BACKEND ---
      - name: ğŸš€ Build et Push l'image BACKEND
        uses: docker/build-push-action@v5
        with:
          context: . # Contexte Ã  la racine du dÃ©pÃ´t
          file: ./aspPorcelette/Dockerfile # Chemin vers le Dockerfile de l'API
          push: true
          tags: ${{ steps.meta.outputs.tags }}-backend # Tag final: 1a2b3c4d-backend
          
      # --- JOB 2 : Construction et Push du FRONTEND ---
      - name: ğŸš€ Build et Push l'image FRONTEND
        uses: docker/build-push-action@v5
        with:
          context: ./asp-porcelette-front # Contexte limitÃ© au dossier du frontend
          file: ./asp-porcelette-front/Dockerfile # Chemin vers le Dockerfile du frontend
          push: true
          tags: ${{ steps.meta.outputs.tags }}-frontend # Tag final: 1a2b3c4d-frontend
          
      - name: âœ… CI terminÃ©e
        run: echo "Images taguÃ©es avec ${{ steps.meta.outputs.tags }} et poussÃ©es sur Docker Hub."